name: Salesforce CI: Validate Pull Request

# Ten workflow uruchamia siƒô automatycznie przy zdarzeniach Pull Request
on:
  pull_request:
    types: [opened, synchronize, reopened] # Uruchamia przy otwarciu PR lub po ka≈ºdym PUSHU do PR
    branches:
      - development  # Dotyczy PR celujƒÖcych w development
      - qa           # Dotyczy PR celujƒÖcych w qa
    paths:
      - 'force-app/**' # Ogranicza uruchomienie tylko do zmian w folderze z metadanymi Salesforce

jobs:
  # WALIDACJA METADANYCH I TESTY
  # To zadanie zwraca status (zielony/czerwony) do Pull Requesta
  validate_code:
    name: üõ°Ô∏è Validate Deploy & Run Local Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # ZMIANA: Instalacja Node.js (wymagana przez sf cli)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      # ZMIANA: Instalacja nowego Salesforce CLI (sf)
      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      # ZMIANA: Bezpieczne tworzenie pliku klucza JWT
      - name: Create JWT Key File
        run: |
          # Odtw√≥rz plik klucza prywatnego z Secrets
          echo "${{ secrets.SF_JWT_KEY }}" > jwt-key.txt
          chmod 600 jwt-key.txt
          
      # ZMIANA: Autoryzacja do Orga Docelowego (U≈ºycie JWT i nowej sk≈Çadni sf)
      - name: Authorize Target Org for Validation
        run: |
          sf org login jwt \
            --client-id ${{ secrets.M_SF_CLIENT_ID }} \
            --jwt-key-file jwt-key.txt \
            --username ${{ secrets.M_SF_USERNAME }} \
            --instance-url ${{ secrets.M_SF_INSTANCE_URL }} \
            --alias validation-org
          
      # Ustawienie Aliasu (opcjonalne, ale dobra praktyka)
      - name: Set default org (Optional)
        run: |
          sf config set default-org validation-org

      # KLUCZOWA KOMENDA SFDX 1: Walidacja (Deployment Check Only)
      - name: Perform Validation Deploy Check
        run: |
          # U≈ºywamy starszej komendy sfdx dla sprawdzonego deploymentu
          sfdx force:source:deploy \
            --sourcepath force-app \
            --targetusername validation-org \
            --checkonly \
            --testlevel RunLocalTests # Flaga do walidacji kodu i test√≥w